<style>
.tracker-header {
    background: white;
    border-bottom: 1px solid #E5E7EB;
    padding: 32px 0;
    margin-bottom: 24px;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 24px;
}

.stat-card {
    padding: 20px;
    background: #F9FAFB;
    border-radius: 12px;
    border: 1px solid #E5E7EB;
}

.stat-card .number {
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #111827;
}

.stat-card .label {
    font-size: 13px;
    color: #6B7280;
    font-weight: 500;
}

.app-card {
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
    transition: all 0.2s;
}

.app-card:hover {
    border-color: #D1D5DB;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
}

.status-badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.status-saved { background: #F3F4F6; color: #374151; }
.status-applied { background: #EEF2FF; color: #4F46E5; }
.status-interviewing { background: #FEF3C7; color: #D97706; }
.status-offer { background: #D1FAE5; color: #065F46; }
.status-rejected { background: #FEE2E2; color: #DC2626; }

.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    background: white;
    padding: 4px;
    border-radius: 10px;
    border: 1px solid #E5E7EB;
    overflow-x: auto;
}

.tab {
    padding: 10px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 13px;
    color: #6B7280;
    border-radius: 6px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
}

.tab:hover {
    color: #111827;
    background: #F9FAFB;
}

.tab.active {
    color: #6366F1;
    background: #EEF2FF;
}

.empty-state {
    text-align: center;
    padding: 80px 20px;
    background: white;
    border-radius: 12px;
    border: 1px solid #E5E7EB;
}

.empty-state svg {
    width: 64px;
    height: 64px;
    margin: 0 auto 24px;
    color: #D1D5DB;
}
</style>

<div class="tracker-header">
    <div class="container">
        <h1>Application Tracker</h1>
        <p style="color: #6B7280; margin-top: 8px;">Monitor and manage your job applications</p>
        
        <div class="stats">
            <div class="stat-card">
                <div class="number">{{jobs.length}}</div>
                <div class="label">Total</div>
            </div>
            <div class="stat-card">
                <div class="number" id="saved-count">0</div>
                <div class="label">Saved</div>
            </div>
            <div class="stat-card">
                <div class="number" id="applied-count">0</div>
                <div class="label">Applied</div>
            </div>
            <div class="stat-card">
                <div class="number" id="response-count">0</div>
                <div class="label">Responses</div>
            </div>
        </div>
        
        <div style="margin-top: 24px; padding: 20px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h3 style="font-size: 15px; margin-bottom: 4px;">Email Integration</h3>
                    <p style="font-size: 13px; color: #6B7280;">Auto-update statuses from Gmail responses</p>
                </div>
                <a href="/auth/google" class="btn">Connect Gmail</a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="tabs">
        <button class="tab active" data-status="all">All</button>
        <button class="tab" data-status="saved">Saved</button>
        <button class="tab" data-status="applied">Applied</button>
        <button class="tab" data-status="interviewing">Interviewing</button>
        <button class="tab" data-status="offer">Offered</button>
        <button class="tab" data-status="rejected">Rejected</button>
    </div>
    
    <div id="applications-container">
        {{#if jobs.length}}
            {{#each jobs}}
            <div class="app-card" data-status="{{this.status}}">
                <div style="display: flex; justify-content: space-between; gap: 24px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <h3>{{this.title}}</h3>
                        <p style="color: #6B7280; margin: 6px 0; font-size: 15px;">{{this.company}}</p>
                        <p style="color: #9CA3AF; font-size: 13px; margin-top: 8px;">
                            Added {{formatDate this.dateAdded}}
                        </p>
                        <div style="margin-top: 12px;">
                            <span class="status-badge status-{{this.status}}">{{this.status}}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px; min-width: 220px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #6B7280; margin-bottom: 6px; font-weight: 500;">Status</label>
                            <select class="status-select" data-job-id="{{this._id}}" style="width: 100%; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 13px;">
                                <option value="saved" {{#if (eq this.status "saved")}}selected{{/if}}>Saved for Later</option>
                                <option value="applied" {{#if (eq this.status "applied")}}selected{{/if}}>Applied</option>
                                <option value="interviewing" {{#if (eq this.status "interviewing")}}selected{{/if}}>Interviewing</option>
                                <option value="offer" {{#if (eq this.status "offer")}}selected{{/if}}>Offered</option>
                                <option value="rejected" {{#if (eq this.status "rejected")}}selected{{/if}}>Rejected</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 4px;">
                            <a href="{{this.link}}" target="_blank" class="btn btn-secondary" style="flex: 1; text-align: center; padding: 10px; font-size: 13px;">View Job</a>
                            <button onclick="deleteJob('{{this._id}}')" class="btn btn-secondary" style="padding: 10px 14px; font-size: 13px;">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            {{/each}}
        {{else}}
        <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <h3>No applications found</h3>
            <p style="color: #6B7280; margin: 12px 0 24px;">Start tracking by searching for jobs and clicking "Save for Later"</p>
            <a href="/" class="btn">Search Jobs</a>
        </div>
        {{/if}}
    </div>
</div>

<script>
// Calculate stats on page load
document.addEventListener('DOMContentLoaded', () => {
    const allJobs = document.querySelectorAll('.app-card');
    const savedCount = document.querySelectorAll('[data-status="saved"]').length;
    const appliedCount = document.querySelectorAll('[data-status="applied"], [data-status="interviewing"], [data-status="offer"], [data-status="rejected"]').length;
    
    document.getElementById('saved-count').textContent = savedCount;
    document.getElementById('applied-count').textContent = appliedCount;
    document.getElementById('response-count').textContent = 0; // You can track responses later
});

// Tab filtering
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const status = this.getAttribute('data-status');
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Filter jobs
        const allCards = document.querySelectorAll('.app-card');
        allCards.forEach(card => {
            if (status === 'all') {
                card.style.display = 'block';
            } else {
                card.style.display = card.getAttribute('data-status') === status ? 'block' : 'none';
            }
        });
    });
});

// Status update
document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', async function() {
        const jobId = this.getAttribute('data-job-id');
        const newStatus = this.value;
        
        try {
            const response = await fetch(`/api/jobs/${jobId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update the card's data-status
                const card = this.closest('.app-card');
                card.setAttribute('data-status', newStatus);
                
                // Update the badge
                const badge = card.querySelector('.status-badge');
                badge.className = `status-badge status-${newStatus}`;
                badge.textContent = newStatus;
                
                showNotification('✓ Status updated!');
                
                // Refresh page to update stats
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(data.error || 'Failed to update');
            }
        } catch (err) {
            console.error('Error updating status:', err);
            showNotification('❌ Failed to update status');
            // Revert the select
            this.value = card.getAttribute('data-status');
        }
    });
});

// Delete job
async function deleteJob(jobId) {
    if (!confirm('Remove this application from tracker?')) return;
    
    try {
        const response = await fetch(`/api/jobs/${jobId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('✓ Job removed');
            setTimeout(() => location.reload(), 500);
        } else {
            throw new Error(data.error || 'Failed to delete');
        }
    } catch (err) {
        console.error('Error deleting job:', err);
        showNotification('❌ Failed to delete job');
    }
}

// Notification helper
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: #111827;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
